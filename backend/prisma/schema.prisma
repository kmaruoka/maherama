// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Shrine {
  id            Int           @id @default(autoincrement())
  name          String        // 神社名
  kana          String?       // 読み
  location      String        // 所在地
  lat           Float         // 緯度
  lng           Float         // 経度
  registered_at DateTime      @default(now())
  shrine_dieties ShrineDiety[]
  shrine_prays  ShrinePray[]
  shrine_pray_stats ShrinePrayStats[]
  shrine_pray_stats_monthly ShrinePrayStatsMonthly[]
  shrine_pray_stats_weekly ShrinePrayStatsWeekly[]
  shrine_pray_stats_daily ShrinePrayStatsDaily[]
  shrine_pray_stats_yearly ShrinePrayStatsYearly[]
  shrine_books ShrineBook[]
  thumbnailUrl  String?       // サムネイル画像URL
  thumbnailBy   String?       // サムネイル投稿ユーザー名
  founded       String?       // 創建
  history       String?       // 歴史・伝承
  festivals     String?       // 祭礼
  description   String?       // 説明文
}

model Diety {
  id           Int           @id @default(autoincrement())
  name         String
  kana         String?
  description  String?
  registered_at DateTime      @default(now())
  shrine_dieties ShrineDiety[]
  diety_prays  DietyPray[]
  diety_pray_stats DietyPrayStats[]
  diety_pray_stats_monthly DietyPrayStatsMonthly[]
  diety_pray_stats_weekly DietyPrayStatsWeekly[]
  diety_pray_stats_daily DietyPrayStatsDaily[]
  diety_pray_stats_yearly DietyPrayStatsYearly[]
  diety_books DietyBook[]
}

model ShrineDiety {
  shrine    Shrine @relation(fields: [shrine_id], references: [id])
  shrine_id Int
  diety     Diety  @relation(fields: [diety_id], references: [id])
  diety_id  Int

  @@id([shrine_id, diety_id])
}

model Log {
  id      Int      @id @default(autoincrement())
  message String
  type    String   @default("normal")
  time    DateTime @default(now())
}

model User {
  id    Int    @id @default(autoincrement())
  name  String
  following Follow[] @relation("follows")
  followers Follow[] @relation("followedBy")
  shrine_books ShrineBook[]
  diety_books DietyBook[]
}

model Follow {
  follower     User @relation("follows", fields: [follower_id], references: [id])
  follower_id  Int
  following    User @relation("followedBy", fields: [following_id], references: [id])
  following_id Int

  @@id([follower_id, following_id])
}

model ShrinePray {
  id        Int      @id @default(autoincrement())
  shrine    Shrine   @relation(fields: [shrine_id], references: [id])
  shrine_id Int
  user_id   Int
  time      DateTime @default(now())
}

model DietyPray {
  id        Int      @id @default(autoincrement())
  diety     Diety    @relation(fields: [diety_id], references: [id])
  diety_id  Int
  user_id   Int
  time      DateTime @default(now())
}

model ShrinePrayStats {
  id        Int      @id @default(autoincrement())
  rank      Int
  shrine    Shrine   @relation(fields: [shrine_id], references: [id])
  shrine_id Int
  user_id   Int
  count     Int
}

model ShrinePrayStatsMonthly {
  id        Int      @id @default(autoincrement())
  rank      Int
  shrine    Shrine   @relation(fields: [shrine_id], references: [id])
  shrine_id Int
  user_id   Int
  count     Int
}

model ShrinePrayStatsWeekly {
  id        Int      @id @default(autoincrement())
  rank      Int
  shrine    Shrine   @relation(fields: [shrine_id], references: [id])
  shrine_id Int
  user_id   Int
  count     Int
}

model ShrinePrayStatsDaily {
  id        Int      @id @default(autoincrement())
  rank      Int
  shrine    Shrine   @relation(fields: [shrine_id], references: [id])
  shrine_id Int
  user_id   Int
  count     Int
}

model ShrinePrayStatsYearly {
  id        Int      @id @default(autoincrement())
  rank      Int
  shrine    Shrine   @relation(fields: [shrine_id], references: [id])
  shrine_id Int
  user_id   Int
  count     Int
}

model DietyPrayStats {
  id        Int      @id @default(autoincrement())
  rank      Int
  diety     Diety    @relation(fields: [diety_id], references: [id])
  diety_id  Int
  user_id   Int
  count     Int
}

model DietyPrayStatsMonthly {
  id        Int      @id @default(autoincrement())
  rank      Int
  diety     Diety    @relation(fields: [diety_id], references: [id])
  diety_id  Int
  user_id   Int
  count     Int
}

model DietyPrayStatsWeekly {
  id        Int      @id @default(autoincrement())
  rank      Int
  diety     Diety    @relation(fields: [diety_id], references: [id])
  diety_id  Int
  user_id   Int
  count     Int
}

model DietyPrayStatsDaily {
  id        Int      @id @default(autoincrement())
  rank      Int
  diety     Diety    @relation(fields: [diety_id], references: [id])
  diety_id  Int
  user_id   Int
  count     Int
}

model DietyPrayStatsYearly {
  id        Int      @id @default(autoincrement())
  rank      Int
  diety     Diety    @relation(fields: [diety_id], references: [id])
  diety_id  Int
  user_id   Int
  count     Int
}

model ShrineBook {
  user          User   @relation(fields: [user_id], references: [id])
  user_id       Int
  shrine        Shrine @relation(fields: [shrine_id], references: [id])
  shrine_id     Int
  registered_at DateTime @default(now())

  @@id([user_id, shrine_id])
}

model DietyBook {
  user          User  @relation(fields: [user_id], references: [id])
  user_id       Int
  diety         Diety @relation(fields: [diety_id], references: [id])
  diety_id      Int
  registered_at DateTime @default(now())

  @@id([user_id, diety_id])
}

model RemotePray {
  id        Int      @id @default(autoincrement())
  user_id   Int
  shrine_id Int
  prayed_at DateTime @default(now())
  
  @@unique([user_id, shrine_id])
}

model UserSubscription {
  id         Int      @id @default(autoincrement())
  user_id    Int
  plan_type  String   // "basic", "premium", etc.
  slots      Int      // 課金口数（遥拝可能神社数）
  expires_at DateTime
  created_at DateTime @default(now())
}
