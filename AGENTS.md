# 実装規約

- 標準的な命名スタイルを採用
- フロントエンドのビジュアルコンポーネントはatomic designを採用
- DBアクセスはN+1問題に注意
- スタイルは全てスキンに定義し、ハードコーディング禁止
- try-catchでエラーを握りつぶすような実装やエラー対応は禁止


# アプリケーション仕様書

## 概要

- Ingress、ポケモンGO、ドラクエウォーク等に代表される、GPSと地図を用いたアプリ。 
- 日本全国の神社の座標が登録されており、参拝(一定の距離に近付いてタップ)することで、神社と祀られている神様が図鑑に登録される。 
- 戦闘などの要素はなく、参拝による神社と神の図鑑コレクション、称号収集、コミュニケーションを楽しむアプリである。

## 画面構成

地図、図鑑、ユーザー、設定、サブメニューを下部メニューバー（アイコン）で切り替え可能

### 地図
	画面いっぱいに現在地を中心とした2D地図が広がっている。
	地図上には日本全国の神社マーカーがサムネイル表示されている。
	現在地の周囲には半径100m（初期値）の円が表示されている。
	円の中に入った神社に参拝ができる。
	参拝した神社とその祭神が図鑑に登録され、参拝数がカウントアップする。
	1日に1つの神社に1回しか参拝できない。
	画面下部にログペインがある。
	ログペインはタップすると画面いっぱいに拡大され、もう一度タップすると元のサイズに戻る。
	ログには、自分やフォローしているユーザーの参拝や称号獲得などの情報が流れる。

### 図鑑
	神社と神がある。（タブで分かれている。）
	デフォルトでは図鑑登録日（表示精度は日、内部精度はミリ秒）の降順に表示される。
	図鑑登録日、最終参拝日、名前、参拝数の昇順・降順に変更できる。
	表示スタイルは、カード（アイキャッチ画像と名前）とリスト（名前、参拝数、図鑑登録日、最終参拝日）が選択できる。
	名前をタップすると神社および神様の詳細情報がモーダル表示される。

	- 神社情報モーダル
		以下の情報が表示される。
			名前
				漢字と読み仮名
			サムネイル画像（拡大表示あり）
				図鑑に登録された神社には画像をアップロード（正方形トリミング）できる。
					投票システム参照
			所在地
			創建
			祭神（拡大表示あり）
				祀られている神の一覧
				（名前をタップすると、神様情報モーダルに遷移する。）
			歴史・伝承（拡大表示あり）
				ユーザーが投稿できる。
				（承認制にすることも検討する。）
			祭礼（拡大表示あり）
			ランキング（拡大表示あり）
				総合、年間、月間、週間をタブで切り替え可能
				参拝数の上位ユーザーが3位まで表示される。
				タップするとこのペインが全画面になって100位まで表示される。
				（名前をタップすると、ユーザー情報モーダルに遷移する。）
			コメント（拡大表示あり）
				一度参拝した神社にはコメントを投稿できる。
				自分以外のユーザーが投稿したコメントには1人1回のみ「Good」「Bad」投票ができる。
		
	- 神様情報モーダル
		以下の情報が表示される。
			名前
				漢字と読み仮名
			サムネイル画像（拡大表示あり）
				図鑑に登録された神には画像をアップロード（正方形トリミング）できる。
				（1人1枚まで、などの制限を設ける。）
				（承認制にすることも検討する。）
				画像には投票（いいね／Good）でき、投票ランキング一位の画像がサムネイルとして採用される。
				（リアルタイム更新はサーバーに負荷がかかるので、1日1回更新する。）
				（名前をタップすると、ユーザー情報ページに遷移する。）
			神社（拡大表示あり）
				祀られている神社の一覧
				（名前をタップすると、神情報ページに遷移する。）
			歴史・伝承（拡大表示あり）
				ユーザーが投稿できる。
				（承認制にすることも検討する。）
			系譜（拡大表示あり）
				父、母、子、祖父、祖母、孫、兄弟姉妹など、二親等まで表示する。
				（名前をタップすると、神情報ページに遷移する。）
			ランキング（拡大表示あり）
				総合、年間、月間、週間をタブで切り替え可能
				参拝数の上位ユーザーが3位まで表示される。
				タップするとこのペインが全画面になって100位まで表示される。
				（名前をタップすると、ユーザー情報モーダルに遷移する。）
			コメント（拡大表示あり）
				一度参拝した神社にはコメントを投稿できる。
				自分以外のユーザーが投稿したコメントには1人1回のみ「Good」「Bad」投票ができる。

### ユーザー
	以下の情報が表示される。
		名前
		ID
		サムネイル画像（アップロード可能（正方形トリミング））
		獲得称号
			称号の例
				大阪市の神社を全て参拝
				大阪市西区の神社を全て参拝
				正勝吾勝勝速日天忍穂耳命を祀る神社を全て参拝
				2019年豊中稲荷神社参拝ランキング1位
				など。
				（名前をタップすると、神社情報・神情報ページに遷移する。）
				（大阪市や大阪市西区などの地域名をタップすると、その地域の神社一覧ページに遷移する。）
		参拝数上位神社
			5位まで表示
			（名前をタップすると、神社情報ページに遷移する。）
		参拝数上位神
			5位まで表示
			（名前をタップすると、神情報ページに遷移する。）
		フォローしているユーザー数
			タップするとユーザーの一覧が表示される。
			（名前をタップすると、ユーザー情報ページに遷移する。）
		フォローされているユーザー数
			タップするとユーザーの一覧が表示される。
			（名前をタップすると、ユーザー情報ページに遷移する。）
	フォロー・アンフォローが可能

### 設定
	- 年齢を公開する(デフォルト: OFF)
	- 性別を公開する(デフォルト: OFF)
	- 参拝数を公開する(デフォルト: OFF)
	- フォローを承認制にする(デフォルト: OFF)
	- 参拝ログを表示する(デフォルト: ON)
	
### サブメニュー
	称号、実績、地域、など、今後のシステム改定に対応

## その他システム

### 投票システム
	ユーザーがアップロードした画像は、その神社や神様の最初の投稿であれば即採用される。
	既存の画像が設定されている場合、翌月1か月の投票期間を経て、得票数1位の画像が翌々月に採用される。
	マーカーを除く画像の左下に「by ●●」という形でユーザー名が表示される。
	（名前をタップすると、ユーザー情報モーダルに遷移する。）


### 遥拝システム
	1日に1回（デフォルト）全国の任意の神社に遥拝できる。
	レベルアップや能力解放により回数は増える。
	
### 経験値システム
	経験値を積んでレベルアップしていく
		(1) 参拝することで経験値を獲得
		(2) 一定の経験値を集めるとレベルアップし、能力値を獲得
		(3) レベルに応じて能力が解放
	レベルが上がるにつれて、参拝距離が伸びるなどの能力が解放されていく（設定変更可能）

	能力の種類は以下のようなものを検討中（設定変更可能）
	プレイスタイルによって選択
		- 100: 参拝距離 + 10m (購入するごとに消費ポイント+100)
		- 5000: 1日の遥拝回数 + 1
		- 200: 歴史・伝承の投稿
		- 200: 神社の申請
		- 50000: 伝承や神社の承認権限 (運営による審査あり)

	経験値獲得方法（設定変更可能）
		参拝: 10ポイント
		遥拝: 10ポイント
		画像投稿: 10ポイント
		称号獲得: 50ポイント～ (難易度による)
		神社申請→承認: 200ポイント

## 課金要素案
	- 500円/月: 参拝距離 * 2
	- 500円/月: 1日の遥拝回数 + 1
	- 500円: 能力値の初期化

# 技術スタック
	- 互換性・実装コスト・スケーラビリティ考慮

## フロントエンド
- React + TypeScript
- React Router
- Leaflet.js（軽量でLeafletプラグインが豊富）
- React Query（状態管理不要、キャッシュ+フェッチ一体化）
- React-Bootstrap（TailWind等のライブライ併用は避ける）
- i18next（将来的な多言語展開に備える）
- PWA対応（Service Worker + manifest）

## バックエンド（BFF）
- Node.js + Express（軽量、高い自由度）
- PostgreSQL + PostGIS（距離検索に最適）
- Prisma ORM（型安全＋スキーマ駆動、PostGISはRaw SQLで補完）
- JWT認証（匿名/ユーザーの統合管理）
- Firebase Auth + Firebase Storage（認証＆画像保管だけ使う）

## 通知・リアルタイム
- Firebase Cloud Messaging（Web Push対応・無料枠あり）
- WebSocket（socket.io）または Supabaseのリアルタイム機能

## 管理画面
- Next.js + Admin UI（React流儀のまま管理画面を構築）
- 非公開API設計で承認ワークフローを分離

## 決済
- Stripe（遥拝/距離拡張の月額課金対応）

## ホスティング・CDN
- フロント：Vercel（PWAに最適）
- API：Railway / Render（Node.jsコンテナ）
- Cloudflare（CDN & HTTPS）

## CI/CD
- GitHub Actions（フロント＋バック自動デプロイ）
